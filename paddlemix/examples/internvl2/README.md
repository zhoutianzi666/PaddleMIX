# InternVL2 æ¨¡å‹


## 0. å¤šæ¨¡æ€ç†è§£å¤§æ¨¡å‹ä»‹ç»
å¤šæ¨¡æ€ç†è§£å¤§æ¨¡å‹æ˜¯ä¸€ç±»èƒ½å¤ŸåŒæ—¶å¤„ç†å’Œç†è§£å¤šç§æ•°æ®å½¢å¼ï¼ˆå¦‚å›¾åƒğŸ“¸ã€æ–‡æœ¬ğŸ“ã€è§†é¢‘ğŸ¥ç­‰ï¼‰çš„äººå·¥æ™ºèƒ½æ¨¡å‹ã€‚è¿™ç±»æ¨¡å‹é€šè¿‡æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼Œå¯ä»¥å®ç°è·¨æ¨¡æ€çš„ä¿¡æ¯ç†è§£ã€å…³è”å’Œç”Ÿæˆï¼ç›¸æ¯”ä¼ ç»Ÿçš„å•æ¨¡æ€æ¨¡å‹ï¼Œå¤šæ¨¡æ€æ¨¡å‹èƒ½å¤Ÿæ›´å…¨é¢åœ°ç†è§£å’Œåˆ†æå¤æ‚åœºæ™¯ï¼Œåœ¨å®é™…åº”ç”¨ä¸­å…·æœ‰æ›´å¼ºçš„å®ç”¨æ€§å’Œæ™®é€‚æ€§ã€‚âœ¨å…¸å‹åº”ç”¨åŒ…æ‹¬ï¼šå›¾æ–‡ç†è§£ã€è§†è§‰é—®ç­”ã€æ–‡æ¡£ç†è§£ã€åœºæ™¯æè¿°ç­‰ä»»åŠ¡ã€‚éšç€æŠ€æœ¯çš„å‘å±•ï¼Œå¤šæ¨¡æ€å¤§æ¨¡å‹åœ¨å‡†ç¡®æ€§ã€é²æ£’æ€§å’Œé€šç”¨æ€§ç­‰æ–¹é¢éƒ½å–å¾—äº†æ˜¾è‘—è¿›æ­¥ï¼Œä¸ºäººå·¥æ™ºèƒ½çš„å‘å±•å¼€è¾Ÿäº†æ–°çš„æ–¹å‘ï¼ğŸ¯

ä¸‹é¢ä»‹ç» InternVL2ï¼Œä¸€ä¸ªå¼ºå¤§çš„å¼€æºå¤šæ¨¡æ€å¤§è¯­è¨€æ¨¡å‹ï¼ˆMLLMï¼‰ã€‚InternVL2 ç³»åˆ—åŒ…å«ä»é€‚ç”¨äºå‚æ•°è¾ƒå°çš„1Bæ¨¡å‹åˆ°åŠŸèƒ½æ›´å¼ºå¤§çš„æ¨¡å‹ã€‚å‡­å€Ÿæ›´å¤§è§„æ¨¡çš„è¯­è¨€æ¨¡å‹ï¼ŒInternVL2-Pro å±•ç°å‡ºå“è¶Šçš„å¤šæ¨¡æ€ç†è§£èƒ½åŠ›ï¼Œåœ¨å„ç§åŸºå‡†æµ‹è¯•ä¸­å¯ä¸å•†ä¸šé—­æºæ¨¡å‹ç›¸åª²ç¾ã€‚ğŸŒˆ

<div style="text-align: center; width: 100%;">
    <img src="https://github.com/user-attachments/assets/772bad8a-c55e-4fbc-b148-fbcd7bd424cb" alt="InternVL2 Benchmark" style="width: 80%; height: auto;">
</div>

## 1. æ¨¡å‹ä»‹ç»

<div style="text-align: center; width: 100%;">
    <img src="https://github.com/user-attachments/assets/78f3094c-85d9-4dbf-8fd6-5c1c6a90dbf5" alt="InternVL2 Architecture" style="width: 90%; height: auto;">
</div>

[InternVL2](https://internvl.github.io/blog/2024-07-02-InternVL-2.0/)æ˜¯ InternVL ç³»åˆ—å¤šæ¨¡æ€ç†è§£å¤§æ¨¡å‹çš„æœ€æ–°æˆå‘˜ã€‚InternVL2 åŒ…å«å¤šä¸ªç»è¿‡æŒ‡ä»¤å¾®è°ƒçš„æ¨¡å‹ï¼Œå‚æ•°é‡ä» 1B åˆ° 76B ä¸ç­‰ã€‚åœ¨å¼€æºæ¨¡å‹ä¸­ï¼ŒInternVL2 åœ¨æ–‡æ¡£å’Œå›¾è¡¨ç†è§£ã€ä¿¡æ¯å›¾è¡¨é—®ç­”ã€åœºæ™¯æ–‡æœ¬ç†è§£å’Œ OCR ä»»åŠ¡ã€ç§‘å­¦å’Œæ•°å­¦é—®é¢˜è§£å†³ç­‰æ–¹é¢è¡¨ç°å‡ºè‰²ã€‚
[InternVL2-MPO](https://internvl.github.io/blog/2024-11-14-InternVL-2.0-MPO/)æ˜¯æ··åˆåå¥½ä¼˜åŒ–åçš„InternVL2æ¨¡å‹ï¼ŒåŸºäºInternVL2åœ¨å¤šä¸ªåŸºå‡†æµ‹è¯•ä¸­è¡¨ç°å‡ºäº†æ”¹è¿›çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šæ¨¡æ€æ¨ç†æ–¹é¢ã€‚



**æœ¬ä»“åº“æ”¯æŒçš„æ¨¡å‹æƒé‡:**

| Model              |
|--------------------|
| OpenGVLab/InternVL2-1B  |
| OpenGVLab/InternVL2_5-1B  |
| OpenGVLab/InternVL2-2B  |
| OpenGVLab/InternVL2_5-2B  |
| OpenGVLab/InternVL2_5-4B  |
| OpenGVLab/InternVL2-8B  |
| OpenGVLab/InternVL2_5-8B  |
| OpenGVLab/InternVL2-26B |
| OpenGVLab/InternVL2-40B |
| OpenGVLab/InternVL2-8B-MPO |

æ³¨æ„ï¼šä¸huggingfaceæƒé‡åŒåï¼Œä½†æƒé‡ä¸ºpaddleæ¡†æ¶çš„Tensorï¼Œä½¿ç”¨`xxx.from_pretrained("OpenGVLab/InternVL2-2B")`å³å¯è‡ªåŠ¨ä¸‹è½½è¯¥æƒé‡æ–‡ä»¶å¤¹åˆ°ç¼“å­˜ç›®å½•ã€‚


## 2 ç¯å¢ƒå‡†å¤‡(å¦‚ç¬¦åˆåˆ™è·³è¿‡)
* é€šè¿‡ `git clone` å‘½ä»¤æ‹‰å– PaddleMIX æºç ï¼Œå¹¶å®‰è£…å¿…è¦çš„ä¾èµ–åº“ã€‚
* Pythonç‰ˆæœ¬æœ€å¥½ä¸º3.10åŠä»¥ä¸Šç‰ˆæœ¬ã€‚
* PaddleNLPç‰ˆæœ¬æœ€å¥½ä¸º3.0åŠä»¥ä¸Šã€‚
> æ³¨ï¼šæœ¬æ¨¡å‹è®­ç»ƒä¸æ¨ç†éœ€è¦ä¾èµ– CUDA 11.2 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå¦‚æœæœ¬åœ°æœºå™¨ä¸ç¬¦åˆè¦æ±‚ï¼Œå»ºè®®å‰å¾€ [AI Studio](https://aistudio.baidu.com/index) è¿›è¡Œæ¨¡å‹è®­ç»ƒã€æ¨ç†ä»»åŠ¡ã€‚æ¨èä½¿ç”¨Linuxç³»ç»Ÿï¼ŒWindowsç³»ç»Ÿæœªç»è¿‡ç³»ç»Ÿæµ‹è¯•ã€‚

## 3. æ¨¡å‹æ¨ç†é¢„æµ‹

### 3.1. å›¾ç‰‡é¢„æµ‹

<div style="text-align: center; width: 100%;">
    <img src="https://raw.githubusercontent.com/PaddlePaddle/PaddleMIX/develop/paddlemix/demo_images/examples_image1.jpg" alt="InternVL2 Benchmark" style="width: 50%; height: auto;">
</div>

```bash
python paddlemix/examples/internvl2/chat_demo.py \
    --model_name_or_path "OpenGVLab/InternVL2-8B" \
    --image_path 'paddlemix/demo_images/examples_image1.jpg' \
    --text "Please describe this image in detail."
```
å¯é…ç½®å‚æ•°è¯´æ˜ï¼š
  * `model_name_or_path`: æŒ‡å®š internvl2 çš„æ¨¡å‹åå­—æˆ–æƒé‡è·¯å¾„ä»¥åŠtokenizerç»„ä»¶ï¼Œé»˜è®¤ OpenGVLab/InternVL2-8Bï¼Œä¹Ÿå¯é€‰æ‹© OpenGVLab/InternVL2-2B
  * `image_path`: æŒ‡å®šå›¾ç‰‡è·¯å¾„
  * `text`: ç”¨æˆ·æŒ‡ä»¤, ä¾‹å¦‚ "Please describe this image in detail."

### 3.2. è§†é¢‘é¢„æµ‹



<div style="display: flex; justify-content: center; align-items: center;">
    <video style="width: 25%; height: auto;" >
        <source src="https://raw.githubusercontent.com/PaddlePaddle/PaddleMIX/develop/paddlemix/demo_images/red-panda.mp4" type="video/mp4">
    </video>
</div>

```bash
python paddlemix/examples/internvl2/chat_demo_video.py \
    --model_name_or_path "OpenGVLab/InternVL2-8B" \
    --video_path 'paddlemix/demo_images/red-panda.mp4' \
    --text "Please describe this video in detail."
```
å¯é…ç½®å‚æ•°è¯´æ˜ï¼š
  * `model_name_or_path`: æŒ‡å®š internvl2 çš„æ¨¡å‹åå­—æˆ–æƒé‡è·¯å¾„ä»¥åŠtokenizerç»„ä»¶ï¼Œé»˜è®¤ OpenGVLab/InternVL2-8Bï¼Œä¹Ÿå¯é€‰æ‹© OpenGVLab/InternVL2-2B
  * `video_path`: æŒ‡å®šè§†é¢‘è·¯å¾„
  * `text`: ç”¨æˆ·æŒ‡ä»¤, ä¾‹å¦‚ "Please describe this video in detail."


## 4 æ¨¡å‹å¾®è°ƒ

### 4.1 å¾®è°ƒæ•°æ®å‡†å¤‡

#### æ•°æ®é›†ä¸‹è½½
SFTæ•°æ®é›†é‡‡ç”¨ InternVL2 å®˜æ–¹å…¬å¸ƒçš„1.3Mçš„SFTæ•°æ®é›†ï¼Œæ€»å…±åŒ…å«çº¦ 120 ä¸‡ä¸ªå®Œå…¨å¼€æºçš„è§†è§‰æŒ‡ä»¤è°ƒä¼˜æ ·æœ¬ã€‚ä»å®è§‚è§’åº¦æ¥çœ‹ï¼Œåœ¨ ShareGPT-4V çš„åŸºç¡€ä¸Šï¼Œè¿˜æ•´åˆäº† LLaVA-ZHã€DVQAã€ChartQAã€AI2Dã€DocVQAã€GeoQA+ å’Œ SynthDoG-ENã€‚å¤§éƒ¨åˆ†æ•°æ®ä¸ LLaVA-NeXT ä¿æŒä¸€è‡´ã€‚

PaddleMIXå›¢é˜Ÿæ•´ç†åçš„ä¸‹è½½é“¾æ¥ä¸ºï¼š
```
wget https://paddlenlp.bj.bcebos.com/datasets/paddlemix/playground.tar # 50G
wget https://paddlenlp.bj.bcebos.com/datasets/paddlemix/LLaVA/LLaVA-SFT.tar # 116G
```
ä¸‹è½½åå¯è§£å‹æˆ–è½¯é“¾æ¥åœ¨ PaddleMIX/ ç›®å½•ä¸‹ã€‚

**PaddleMIXå›¢é˜Ÿä¹Ÿæä¾›äº†å…¶ä¸­å•ç‹¬çš„`chartqa`æ•°æ®é›†çš„ä¸‹è½½é“¾æ¥ï¼Œä½œä¸ºè®­ç»ƒç¤ºä¾‹ï¼ˆå…¥é—¨æ¨èï¼‰ï¼š**
```
wget https://paddlenlp.bj.bcebos.com/datasets/paddlemix/playground/data/chartqa.tar # 1.1G
wget https://paddlenlp.bj.bcebos.com/datasets/paddlemix/playground/opensource.tar # 5.2G
```

chartqa.taréœ€ä¸‹è½½è§£å‹åœ¨playground/data/ç›®å½•ä¸‹ï¼Œopensource.taréœ€ä¸‹è½½è§£å‹åœ¨playground/ç›®å½•ä¸‹ï¼Œopensourceé‡Œæ˜¯æ•°æ®æ ‡æ³¨çš„jsonlæ–‡ä»¶ã€‚

----
#### æ•°æ®é›†ä»‹ç»
æ•°æ®é›†åŒ…å«ä»¥ä¸‹æ•°æ®é›†ï¼š
* AI2Dï¼šai2d_imagesï¼ˆç”± InternLM-XComposer æä¾›ï¼‰
* ChartQAï¼šChartQA Dataset
* COCOï¼štrain2017
* DocVQAï¼štrainã€valã€test
* DVQAï¼šimages
* GQAï¼šimages
* LLaVA-Pretrainï¼šimages
* OCR-VQAï¼šä¸‹è½½è„šæœ¬ã€‚æˆ‘ä»¬å°†æ‰€æœ‰æ–‡ä»¶ä¿å­˜ä¸º `.jpg`
* SAMï¼šç›®å‰æˆ‘ä»¬ä»…ä½¿ç”¨ 000000~000050.tarã€‚æ‚¨å¯ä»¥ä»è¿™é‡Œå¿«é€Ÿä¸‹è½½ 9K å¼ å›¾åƒã€‚
* TextVQAï¼štrainvalimages
* SynthDoG-ENï¼šç›®å‰æˆ‘ä»¬ä»…ä½¿ç”¨ 00000~00004 parquet æ–‡ä»¶ï¼Œå…± 3 ä¸‡å¼ å›¾åƒã€‚æˆ‘ä»¬æä¾›äº†è½¬æ¢åçš„å›¾åƒã€‚
* VisualGenomeï¼špart1ã€part2
* WebDataï¼šimagesã€‚ä»…ä¾›å­¦æœ¯ä½¿ç”¨ã€‚
* GeoQA+ï¼šimagesã€‚æˆ‘ä»¬å·²è½¬æ¢æ•°æ®æ ¼å¼å¹¶é‡æ–°å‘å¸ƒã€‚


#### æ•°æ®é›†ç»„ç»‡ç»“æ„
æŒ‰ç…§ä»¥ä¸‹æ–¹å¼åœ¨ `playground/data` ä¸­ç»„ç»‡æ•°æ®ï¼š

```
playground/
â”œâ”€â”€ opensource
â”‚   â”œâ”€â”€ ai2d_train_12k.jsonl
â”‚   â”œâ”€â”€ chartqa_train_18k.jsonl
â”‚   â”œâ”€â”€ docvqa_train_10k.jsonl
â”‚   â”œâ”€â”€ dvqa_train_200k.jsonl
â”‚   â”œâ”€â”€ geoqa+.jsonl
â”‚   â”œâ”€â”€ llava_instruct_150k_zh.jsonl
â”‚   â”œâ”€â”€ sharegpt4v_instruct_gpt4-vision_cap100k.jsonl
â”‚   â”œâ”€â”€ sharegpt4v_mix665k_cap23k_coco-ap9k_lcs3k_sam9k_div2k.jsonl
â”‚   â””â”€â”€ synthdog_en.jsonl
â”œâ”€â”€ data
â”‚   â”œâ”€â”€ ai2d
â”‚   â”‚   â”œâ”€â”€ abc_images
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ chartqa
â”‚   â”‚   â”œâ”€â”€ test
â”‚   â”‚   â”œâ”€â”€ train
â”‚   â”‚   â””â”€â”€ val
â”‚   â”œâ”€â”€ coco
â”‚   â”‚   â””â”€â”€ train2017
â”‚   â”œâ”€â”€ docvqa
â”‚   â”‚   â”œâ”€â”€ test
â”‚   â”‚   â”œâ”€â”€ train
â”‚   â”‚   â””â”€â”€ val
â”‚   â”œâ”€â”€ dvqa
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ gqa
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ llava
â”‚   â”‚   â””â”€â”€ llava_pretrain
â”‚   â”‚       â””â”€â”€ images
â”‚   â”œâ”€â”€ ocr_vqa
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ sam
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ share_textvqa
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ synthdog-en
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ textvqa
â”‚   â”‚   â””â”€â”€ train_images
â”‚   â”œâ”€â”€ vg
â”‚   â”‚   â”œâ”€â”€ VG_100K
â”‚   â”‚   â””â”€â”€ VG_100K_2
â”‚   â”œâ”€â”€ web-celebrity
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ web-landmark
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ wikiart
â”‚   â”‚   â””â”€â”€ images
â”‚   â”œâ”€â”€ geoqa+
â”‚   â”‚   â””â”€â”€ images
```

### 4.2 å¾®è°ƒå‘½ä»¤

æ³¨æ„ï¼šæ­¤å¾®è°ƒè®­ç»ƒä¸ºå…¨å‚æ•°å¾®è°ƒï¼Œå†»ç»“è§†è§‰ç¼–ç å™¨è€Œæ”¾å¼€LLMè®­ç»ƒï¼Œ1B V100 32Gå¯è·‘ã€‚
2Bæ¨¡å‹å¾®è°ƒè®­ç»ƒçš„æ˜¾å­˜å¤§å°çº¦ä¸º40Gï¼Œ8Bæ¨¡å‹å¾®è°ƒè®­ç»ƒçš„æ˜¾å­˜å¤§å°çº¦ä¸º80Gã€‚

```bash
# å•å¡
# 1B
sh paddlemix/examples/internvl2/shell/internvl2.0/2nd_finetune/internvl2_1b_qwen2_0_5b_dynamic_res_2nd_finetune_full.sh

## å¤šå¡
# 2B
sh paddlemix/examples/internvl2/shell/internvl2.0/2nd_finetune/internvl2_2b_internlm2_1_8b_dynamic_res_2nd_finetune_full.sh 

## å¤šå¡
# 8B
sh paddlemix/examples/internvl2/shell/internvl2.0/2nd_finetune/internvl2_8b_internlm2_7b_dynamic_res_2nd_finetune_full.sh
```

### 4.3 å¾®è°ƒåä½¿ç”¨

åŒæŒ‰æ­¥éª¤3ä¸­çš„æ¨¡å‹æ¨ç†é¢„æµ‹ï¼Œåªéœ€å°†`model_name_or_path`å‚æ•°ä¿®æ”¹ä¸ºå¾®è°ƒåçš„æ¨¡å‹è·¯å¾„å³å¯ã€‚

```bash
python paddlemix/examples/internvl2/chat_demo.py \
    --model_name_or_path "your_checkpoints" \
    --image_path 'paddlemix/demo_images/examples_image1.jpg' \
    --text "Please describe this image in detail."
```

### 4.4 MiniMonkey æ¨¡å‹

[MiniMonkey](https://github.com/Yuliang-Liu/Monkey/blob/main/project/mini_monkey/) æ˜¯åŸºäº InternVL2 çš„ä¸“ç”¨äºOCRæ–‡æ¡£ç†è§£çš„å¤šæ¨¡æ€å¤§æ¨¡å‹ã€‚
å…·ä½“ä½¿ç”¨è¯·å‚ç…§[minimonkey](../minimonkey/)


## 5 NPUç¡¬ä»¶è®­ç»ƒ
è¯·å‚ç…§[tools](../../tools/README.md)è¿›è¡ŒNPUç¡¬ä»¶Paddleå®‰è£…å’Œç¯å¢ƒå˜é‡è®¾ç½®ã€‚
é…ç½®å®Œæˆåå¯ç›´æ¥æŒ‰æ­¥éª¤4ä¸­çš„å¾®è°ƒå‘½ä»¤è¿›è¡Œè®­ç»ƒã€‚


### å‚è€ƒæ–‡çŒ®
```BibTeX
@article{chen2023internvl,
  title={InternVL: Scaling up Vision Foundation Models and Aligning for Generic Visual-Linguistic Tasks},
  author={Chen, Zhe and Wu, Jiannan and Wang, Wenhai and Su, Weijie and Chen, Guo and Xing, Sen and Zhong, Muyan and Zhang, Qinglong and Zhu, Xizhou and Lu, Lewei and Li, Bin and Luo, Ping and Lu, Tong and Qiao, Yu and Dai, Jifeng},
  journal={arXiv preprint arXiv:2312.14238},
  year={2023}
}

@article{chen2024far,
  title={How Far Are We to GPT-4V? Closing the Gap to Commercial Multimodal Models with Open-Source Suites},
  author={Chen, Zhe and Wang, Weiyun and Tian, Hao and Ye, Shenglong and Gao, Zhangwei and Cui, Erfei and Tong, Wenwen and Hu, Kongzhi and Luo, Jiapeng and Ma, Zheng and others},
  journal={arXiv preprint arXiv:2404.16821},
  year={2024}
}
```
